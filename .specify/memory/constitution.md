# WhoThere Analytics Constitution

## Prerequisite: Library Usage Rules

**Before making any changes, you MUST consult the `AGENTS.md` file.**

This file is automatically generated and contains the most current usage rules, patterns, and conventions for the libraries and dependencies used in this project. The constitution provides high-level architectural principles, but `AGENTS.md` provides the specific, up-to-date implementation guidance required for development. Adhering to these library-specific rules is mandatory.

**Refer to `CLAUDE.md` for comprehensive project setup, development commands, and architecture guidelines.**

---

## Core Principles

### I. Phoenix Analytics Library Foundation (NON-NEGOTIABLE)

Every feature MUST be designed as a standalone, self-contained Elixir library that integrates seamlessly with Phoenix applications. The library must be independently testable, documented, and have a clear purpose focused on traffic analytics. No organizational-only libraries - each component must provide specific analytics functionality. Integration must be completely transparent to end users with zero visible impact on their experience.

### II. Invisible Server-Side Monitoring (NON-NEGOTIABLE)

All traffic analysis MUST occur exclusively on the server side with absolutely no indication to end users that monitoring is taking place. No client-side JavaScript, no additional HTTP headers, no performance impact visible to users, no cookies or tracking mechanisms that users can detect. Analytics collection happens through Phoenix plugs, telemetry events, and server-side instrumentation only. User privacy is paramount - collect only what's necessary for operational insights.

### III. Test-First Development with ExUnit (NON-NEGOTIABLE)

TDD mandatory for all analytics features: Tests written → User approved → Tests fail → Then implement. Red-Green-Refactor cycle strictly enforced. Focus on integration tests that verify analytics collection works without affecting normal Phoenix application behavior. Use `describe` blocks to group related tests with descriptive names explaining analytics behavior. Mock external dependencies to ensure tests are fast and reliable.

### IV. Ash Framework 3.x+ Analytics Domain Modeling (NON-NEGOTIABLE)

All analytics business logic MUST be modeled using Ash Framework 3.x+ resources and domains. Analytics data models (sessions, events, metrics) defined as Ash resources with proper actions and policies. Use Ash's built-in features for data validation, aggregations, and real-time analytics. Never bypass Ash for analytics database operations - all analytics data access goes through Ash resources and code interfaces.

### V. Privacy-First Data Collection and Storage

Analytics data collection MUST minimize personal information while maximizing operational insights. Use data aggregation, anonymization, and retention policies to protect user privacy. Store only necessary metadata for traffic analysis. Implement automatic data purging for old analytics data. Use secure storage patterns and never log sensitive user data like passwords, tokens, or personal content.

### VI. Multi-Tenant Analytics Architecture (NON-NEGOTIABLE)

All analytics data MUST be properly isolated by tenant to support multi-tenant Phoenix applications. Use Ash Framework's multitenancy features with tenant-aware resources and policies. Each analytics resource MUST define appropriate multitenancy strategy (attribute-based for shared databases, schema-based for separate schemas). Analytics queries and actions MUST always include tenant context to ensure complete data isolation. Support both single-tenant and multi-tenant deployments through configuration without code changes.

## Technology Stack and Architecture Requirements

### Required Technology Stack

- **Backend**: Phoenix Framework 1.8+ with plugs for traffic interception
- **Analytics Domain**: Ash Framework 3.x+ for all analytics data modeling and business logic
- **Database**: PostgreSQL with Ash.Postgres data layer for analytics storage
- **Multi-tenancy**: Ash Framework multitenancy with configurable tenant isolation strategies
- **Integration**: Phoenix telemetry events and plugs for data collection
- **Frontend**: Phoenix Core Components with DaisyUI styling framework (ships with Phoenix 1.8+)
- **Testing**: ExUnit for unit tests, Phoenix.ConnTest for integration testing
- **Quality Tools**: ex_check with Credo, Dialyzer, Sobelow, mix_audit

### Forbidden Technologies and Patterns

- Do not use client-side analytics tracking or JavaScript libraries
- Avoid storing personally identifiable information (PII) in analytics data
- No direct Ecto queries for analytics - all database access through Ash resources
- Do not impact Phoenix application performance with synchronous analytics processing
- Avoid third-party analytics services that compromise user privacy
- No GenServer for analytics collection - use Ash actions, Reactor workflows and Phoenix telemetry
- Never bypass tenant isolation - all analytics operations must be tenant-aware
- Do not use global analytics aggregations that mix tenant data
- Avoid custom CSS frameworks - use DaisyUI components exclusively for analytics dashboards
- Do not bypass Phoenix Core Components - build analytics UI using standard Phoenix patterns

### Privacy and Security Standards

- Use `{:ok, result}` and `{:error, reason}` tuples consistently for analytics operations
- Analytics processing MUST be asynchronous to avoid impacting user experience
- Implement proper data retention policies with automatic cleanup per tenant
- Use Ash policies for analytics data access control with tenant-aware authorization
- Never log or store sensitive user data in analytics collections
- Ensure tenant data isolation at all levels - database, application, and API
- Implement tenant-specific configuration and customization capabilities

## Development Standards and Quality Gates

### Code Quality Requirements (MANDATORY)

- All code MUST pass `mix check` which includes: compilation with warnings as errors, Credo strict analysis, Dialyzer type checking, Sobelow security scanning, formatter checks, and full test suite
- All code MUST be formatted with `mix format` using project-specific formatters
- Follow Phoenix and Elixir naming conventions: Modules use `WhoThere.Domain.Resource` pattern, files use snake_case matching module names
- Use pattern matching extensively and pipeline operator for data transformations
- Files should not exceed 400 lines
- Analytics components must have zero performance impact on host Phoenix applications

### Database and Schema Management

- All database changes MUST use Ash migrations through `mix ash.codegen <name>`
- Use `mix ash.codegen --dev` during development iterations, then finalize with descriptive names
- Run `mix ash.migrate` to apply generated migrations
- Schema changes MUST be backward compatible when possible
- Use database constraints for analytics data integrity enforcement through AshPostgres
- Implement proper indexing for analytics queries without impacting application performance

### Analytics Collection Standards

- All analytics collection MUST be asynchronous and non-blocking
- Use Phoenix telemetry events for data collection points
- Implement circuit breakers for analytics processing to prevent cascading failures
- Analytics data MUST be sanitized and anonymized before storage
- Implement proper error handling that never affects the host application
- Use structured logging for analytics system debugging only
- All analytics operations MUST include tenant context for proper data isolation
- Support tenant-specific analytics configuration and data retention policies
- Support Prometheus style metrics endpoints for monitoring

### Multi-Tenant Architecture Standards

- Use Ash Framework's multitenancy features for all analytics resources
- Support both attribute-based (shared database) and schema-based (separate schemas) tenancy
- Implement tenant context propagation through Phoenix plugs and telemetry metadata
- Ensure analytics queries are automatically scoped to the correct tenant
- Support tenant-specific analytics dashboards and reporting
- Implement tenant isolation verification in all test suites
- Use tenant-aware background job processing for analytics aggregations

### Frontend and UI Standards

- All analytics dashboards MUST use Phoenix Core Components as the foundation
- Use DaisyUI component classes for consistent styling across analytics interfaces
- Build analytics charts and visualizations using Phoenix LiveView with DaisyUI styling
- Analytics UI components MUST follow Phoenix naming conventions and patterns
- Use Phoenix LiveView streams for real-time analytics data updates
- Implement responsive design using DaisyUI's responsive utility classes
- All analytics forms MUST use Ash.Phoenix.Form with DaisyUI form components

## Privacy and Compliance Requirements

### Data Protection Standards

- Analytics data collection MUST comply with privacy regulations (GDPR, CCPA)
- Implement data retention policies with automatic purging and summary tables
- Use data minimization principles - collect only necessary operational data
- Provide mechanisms for data export and deletion upon request
- Never store personally identifiable information in analytics data
- Use hashing and anonymization for any identifiers

### Security Requirements

- All analytics database access MUST use Ash policies for authorization
- Implement proper access controls for analytics data viewing
- Use encrypted storage for sensitive analytics metadata
- Regular security audits for analytics data handling
- Never expose analytics collection mechanisms to end users

## Quality Gate Enforcement (MANDATORY)

After completing any development task, the following steps MUST be executed:

1. **Code Quality Verification**
   - Run `mix check` to ensure all quality tools pass
   - Run `mix format` to ensure consistent code formatting
   - Fix any compilation warnings, Credo issues, or security findings

2. **Migration Management**
   - Run `mix ash.codegen <descriptive_name>` for any Ash resource changes
   - Review generated migrations before applying with `mix ash.migrate`

3. **Performance Impact Testing**
   - Verify analytics collection has zero measurable impact on Phoenix application performance
   - Test analytics processing under load conditions
   - Ensure graceful degradation when analytics systems fail

4. **Privacy Compliance Verification**
   - Verify no PII is collected or stored in analytics data
   - Test data anonymization and retention policies
   - Confirm analytics collection is completely transparent to end users

5. **Multi-Tenant Isolation Testing**
   - Verify complete tenant data isolation in all analytics operations
   - Test tenant context propagation through all analytics collection points
   - Confirm tenant-specific configuration and policies work correctly
   - Validate no cross-tenant data leakage in aggregations or reports

## Governance

### Constitutional Authority

This constitution supersedes all other development practices and standards. Any deviation requires explicit justification and approval through Pull Request review. Complex architectural decisions MUST be documented and aligned with Phoenix/Ash Framework patterns while maintaining privacy-first principles.

### Amendment Process

Constitution changes require: documentation of rationale, privacy impact assessment, performance impact evaluation, migration plan for existing analytics code, and approval from project maintainers. All amendments MUST maintain compatibility with Phoenix 1.8+ and Ash 3.x+ requirements while strengthening privacy protections.

### Code Review Requirements

- All PRs MUST verify compliance with constitutional principles
- Phoenix/Ash pattern adherence is mandatory for approval
- Privacy and security review required for all analytics data handling changes
- Performance impact assessment required for any analytics collection modifications
- User transparency verification - confirm no visible impact on end user experience

### Quality Enforcement

- Use `AGENTS.md` for runtime development guidance and specific library implementation patterns
- Use `CLAUDE.md` for comprehensive project setup and architecture guidelines
- Complexity MUST be justified with clear operational analytics requirements
- Technical debt MUST be tracked and addressed in regular maintenance cycles
- All violations of constitutional principles MUST be documented as technical debt
- Privacy violations are considered critical issues requiring immediate resolution

**Version**: 1.0.0 | **Ratified**: 2025-09-18 | **Last Amended**: 2025-09-18

